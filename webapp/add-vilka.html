<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Добавить вилку</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f0f2f5;
            padding: 20px;
            margin: 0;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        h1 {
            text-align: center;
            color: #333;
        }
        label {
            display: block;
            margin: 10px 0 5px;
            font-weight: bold;
        }
        input {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
        }
        button {
            width: 100%;
            padding: 10px;
            background-color: #5c6bc0;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        button:hover {
            background-color: #3f51b5;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .error {
            color: red;
            font-size: 0.9em;
            margin-bottom: 10px;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Добавить вилку</h1>
        <form id="vilkaForm">
            <label>Дата</label>
            <input type="date" id="date" required>
            
            <label>Событие (Команда А - Команда Б)</label>
            <input type="text" id="event" placeholder="Например, Спартак - Зенит" required>
            
            <label>БК 1</label>
            <input type="text" id="bk1" placeholder="Например, Фонбет" required>
            <label>Исход 1</label>
            <input type="text" id="outcome1" placeholder="Например, П1" required>
            <label>Коэффициент 1</label>
            <input type="number" step="0.01" id="odds1" placeholder="Например, 2.1" min="1" required>
            <label>Ставка 1 (₽)</label>
            <input type="number" id="stake1" placeholder="Например, 1000" min="0" required>
            
            <label>БК 2</label>
            <input type="text" id="bk2" placeholder="Например, Лига Ставок" required>
            <label>Исход 2</label>
            <input type="text" id="outcome2" placeholder="Например, П2" required>
            <label>Коэффициент 2</label>
            <input type="number" step="0.01" id="odds2" placeholder="Например, 2.3" min="1" required>
            <label>Ставка 2 (₽)</label>
            <input type="number" id="stake2" placeholder="Например, 913" min="0" required>
            
            <label>Коэффициент 2 (история)</label>
            <input type="number" step="0.01" id="odds2_history" placeholder="Например, 2.3" min="1" required>
            <label>Прибыль (₽)</label>
            <input type="number" id="profit" placeholder="Рассчитывается автоматически" readonly>
            
            <div id="error" class="error"></div>
            <button type="submit">Сохранить</button>
        </form>
    </div>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        const tg = window.Telegram.WebApp;
        tg.ready();

        // Автоматический расчет прибыли
        function calculateProfit() {
            const odds1 = parseFloat(document.getElementById('odds1').value) || 0;
            const stake1 = parseFloat(document.getElementById('stake1').value) || 0;
            const odds2 = parseFloat(document.getElementById('odds2').value) || 0;
            const stake2 = parseFloat(document.getElementById('stake2').value) || 0;
            const totalStake = stake1 + stake2;
            const profit1 = (odds1 * stake1) - totalStake;
            const profit2 = (odds2 * stake2) - totalStake;
            const profit = Math.min(profit1, profit2); // Минимальная прибыль для вилки
            document.getElementById('profit').value = profit > 0 ? profit.toFixed(2) : 0;
        }

        document.getElementById('odds1').addEventListener('input', calculateProfit);
        document.getElementById('stake1').addEventListener('input', calculateProfit);
        document.getElementById('odds2').addEventListener('input', calculateProfit);
        document.getElementById('stake2').addEventListener('input', calculateProfit);

        document.getElementById('vilkaForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const errorDiv = document.getElementById('error');
            const button = document.querySelector('button');
            button.disabled = true;
            errorDiv.style.display = 'none';

            const formData = {
                date: document.getElementById('date').value,
                event: document.getElementById('event').value.trim(),
                bk1: document.getElementById('bk1').value.trim(),
                outcome1: document.getElementById('outcome1').value.trim(),
                odds1: parseFloat(document.getElementById('odds1').value),
                stake1: parseFloat(document.getElementById('stake1').value),
                bk2: document.getElementById('bk2').value.trim(),
                outcome2: document.getElementById('outcome2').value.trim(),
                odds2_history: parseFloat(document.getElementById('odds2_history').value),
                stake2: parseFloat(document.getElementById('stake2').value),
                profit: parseFloat(document.getElementById('profit').value)
            };

            // Валидация
            const today = new Date().toISOString().split('T')[0];
            if (!formData.event || !formData.bk1 || !formData.bk2 || !formData.outcome1 || !formData.outcome2) {
                errorDiv.textContent = 'Все текстовые поля должны быть заполнены!';
                errorDiv.style.display = 'block';
                button.disabled = false;
                return;
            }
            if (formData.bk1 === formData.bk2) {
                errorDiv.textContent = 'БК 1 и БК 2 не могут быть одинаковыми!';
                errorDiv.style.display = 'block';
                button.disabled = false;
                return;
            }
            if (formData.odds1 <= 1 || formData.odds2_history <= 1) {
                errorDiv.textContent = 'Коэффициенты должны быть больше 1!';
                errorDiv.style.display = 'block';
                button.disabled = false;
                return;
            }
            if (formData.stake1 <= 0 || formData.stake2 <= 0) {
                errorDiv.textContent = 'Ставки должны быть положительными!';
                errorDiv.style.display = 'block';
                button.disabled = false;
                return;
            }
            if (formData.date > today) {
                errorDiv.textContent = 'Дата не может быть в будущем!';
                errorDiv.style.display = 'block';
                button.disabled = false;
                return;
            }
            if (formData.profit <= 0) {
                errorDiv.textContent = 'Прибыль должна быть положительной!';
                errorDiv.style.display = 'block';
                button.disabled = false;
                return;
            }

            try {
                const response = await fetch('https://arbitrageeerbot-backend-danik20021.koyeb.app/save-vilka', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                if (!response.ok) throw new Error(`Ошибка сервера: ${response.status}`);
                const result = await response.json();
                if (result.status === 'error') {
                    errorDiv.textContent = result.message;
                    errorDiv.style.display = 'block';
                    button.disabled = false;
                    return;
                }
                tg.showAlert('Вилка успешно добавлена!');
                tg.close();
            } catch (error) {
                console.error('Ошибка:', error);
                errorDiv.textContent = `Ошибка при сохранении: ${error.message}`;
                errorDiv.style.display = 'block';
                button.disabled = false;
            }
        });
    </script>
</body>
</html>